<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px 30px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar h2 { font-size: 24px; }
        .logoutBtn { background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600; }

        .container { max-width: 1200px; margin: 30px auto; padding: 0 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap; }
        .tab { padding: 12px 24px; background: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover { transform: translateY(-2px); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card h3 { color: #667eea; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }

        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        .info-item { padding: 10px; background: #f9f9f9; border-radius: 5px; }
        .info-label { font-weight: 600; color: #666; font-size: 14px; margin-bottom: 5px; }
        .info-value { color: #333; font-size: 16px; }

        table { width: 100%; border-collapse: collapse; }
        th { background: #667eea; color: white; padding: 12px; text-align: left; font-weight: 600; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }

        .status-badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-scheduled { background: #e3f2fd; color: #1976d2; }
        .status-completed { background: #e8f5e9; color: #388e3c; }
        .status-cancelled { background: #ffebee; color: #d32f2f; }
        .status-no-show { background: #fff3e0; color: #f57c00; }
        .status-paid { background: #e8f5e9; color: #388e3c; }
        .status-pending { background: #fff3e0; color: #f57c00; }
        .status-failed { background: #ffebee; color: #d32f2f; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px; }
        .btn-primary { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 5px; cursor: pointer; font-weight: 600; margin-top: 10px; }
        .btn-primary:hover { background: #5568d3; }

        .success-message { background: #e8f5e9; color: #388e3c; padding: 15px; border-radius: 5px; margin-bottom: 20px; display: none; }

        /* Toast */
        #toast {
            position: fixed; right: 20px; bottom: 20px; z-index: 9999; display: none;
            padding: 12px 16px; background: rgba(0,0,0,0.85); color: #fff; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,.12);
            max-width: 320px; font-weight: 600;
        }

        /* small helper text under appointment form */
        .small { font-size: 13px; color: #666; margin-top: 8px; }
    </style>
</head>
<body>
    <div class="navbar">
        <h2>üè• Patient Portal</h2>
        <div>
            <span id="userName" style="margin-right: 20px;"></span>
            <button id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- toast -->
    <div id="toast"></div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="showTab(event,'profile')">Profile</button>
            <button class="tab" onclick="showTab(event,'appointments')">Appointments</button>
            <button class="tab" onclick="showTab(event,'treatments')">Treatments</button>
            <button class="tab" onclick="showTab(event,'billings')">Billings</button>
            <button class="tab" onclick="showTab(event,'book')">Book Appointment</button>
        </div>

        <!-- Profile Tab -->
        <div id="profile" class="tab-content active">
            <div class="card">
                <h3>Personal Information</h3>
                <div id="profileData" class="info-grid"></div>
            </div>
        </div>

        <!-- Appointments Tab -->
        <div id="appointments" class="tab-content">
            <div class="card">
                <h3>My Appointments</h3>
                <div style="overflow-x: auto;">
                    <table id="appointmentsTable">
                        <thead>
                            <tr>
                                <th>Appointment ID</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Doctor</th>
                                <th>Specialization</th>
                                <th>Reason</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Treatments Tab -->
        <div id="treatments" class="tab-content">
            <div class="card">
                <h3>Treatment History</h3>
                <div style="overflow-x: auto;">
                    <table id="treatmentsTable">
                        <thead>
                            <tr>
                                <th>Treatment ID</th>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Reason for Visit</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Billings Tab -->
        <div id="billings" class="tab-content">
            <div class="card">
                <h3>Billing Information</h3>
                <div style="overflow-x: auto;">
                    <table id="billingsTable">
                        <thead>
                            <tr>
                                <th>Bill ID</th>
                                <th>Date</th>
                                <th>Treatment Type</th>
                                <th>Amount</th>
                                <th>Payment Method</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Book Appointment Tab -->
        <div id="book" class="tab-content">
            <div class="card">
                <h3>Book New Appointment</h3>
                <div class="success-message" id="successMessage">Appointment booked successfully!</div>
                <form id="bookingForm">
                    <div class="form-group">
                        <label for="doctorSelect">Select Doctor</label>
                        <select id="doctorSelect" required>
                            <option value="">Choose a doctor...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="appointmentDate">Appointment Date</label>
                        <input type="date" id="appointmentDate" required>
                    </div>

                    <div class="form-group">
                        <label for="appointmentTime">Appointment Time</label>
                        <input type="time" id="appointmentTime" required>
                    </div>

                    <div class="form-group">
                        <label for="reason">Reason for Visit</label>
                        <select id="reason" required>
                          <option value="">Select reason...</option>
                          <option value="Checkup">Checkup</option>
                          <option value="Consultation">Consultation</option>
                          <option value="Follow-up">Follow-up</option>
                          <option value="Therapy">Therapy</option>
                          <option value="Other">Other (write your reason)</option>
                        </select>
                        <!-- Hidden input that appears when "Other" is chosen -->
                        <input type="text" id="otherReason" placeholder="Describe your reason (if Other)" style="display:none; margin-top:8px; padding:6px; width:100%;" />
                      </div>                      

                    <button type="submit" class="btn-primary">Book Appointment</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // basic auth + config
        const API_URL = window.location.origin + "/api";
        const token = localStorage.getItem('token');
        const userName = localStorage.getItem('name') || '';
        if (!token) {
            window.location.href = '/login';
        }
        document.getElementById('userName').textContent = userName;
        const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };

        document.getElementById("logoutBtn").addEventListener("click", function() {
            localStorage.removeItem("token");
            localStorage.removeItem("role");
            localStorage.removeItem("name");
            window.location.href = "/login";
        });

        // Toast helper
        function showToast(msg, timeout = 4000) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            clearTimeout(t._timer);
            t._timer = setTimeout(()=> { t.style.display = 'none'; }, timeout);
        }

        // Tab switching
        function showTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if (evt && evt.currentTarget) evt.currentTarget.classList.add('active');
        }

        // Load functions
        async function loadProfile() {
            try {
                const response = await fetch(`${API_URL}/patient/profile`, { headers });
                const data = await response.json();
                const profileHTML = `
                    <div class="info-item"><div class="info-label">Patient ID</div><div class="info-value">${data.patient_id||''}</div></div>
                    <div class="info-item"><div class="info-label">Full Name</div><div class="info-value">${data.first_name||''} ${data.last_name||''}</div></div>
                    <div class="info-item"><div class="info-label">Gender</div><div class="info-value">${data.gender||''}</div></div>
                    <div class="info-item"><div class="info-label">Date of Birth</div><div class="info-value">${data.date_of_birth||''}</div></div>
                    <div class="info-item"><div class="info-label">Contact Number</div><div class="info-value">${data.contact_number||''}</div></div>
                    <div class="info-item"><div class="info-label">Email</div><div class="info-value">${data.email||''}</div></div>
                    <div class="info-item"><div class="info-label">Address</div><div class="info-value">${data.address||''}</div></div>
                    <div class="info-item"><div class="info-label">Registration Date</div><div class="info-value">${data.registration_date||''}</div></div>
                    <div class="info-item"><div class="info-label">Insurance Provider</div><div class="info-value">${data.insurance_provider||''}</div></div>
                    <div class="info-item"><div class="info-label">Insurance Number</div><div class="info-value">${data.insurance_number||''}</div></div>
                `;
                document.getElementById('profileData').innerHTML = profileHTML;
            } catch (error) {
                console.error('Error loading profile:', error);
                showToast('Error loading profile');
            }
        }

        async function loadAppointments() {
            try {
                const response = await fetch(`${API_URL}/patient/appointments`, { headers });
                const data = await response.json();
                const tbody = document.querySelector('#appointmentsTable tbody');
                tbody.innerHTML = (data || []).map(apt => `
                    <tr>
                        <td>${apt.appointment_id||''}</td>
                        <td>${apt.appointment_date||''}</td>
                        <td>${apt.appointment_time||''}</td>
                        <td>${apt.doctor_name||''}</td>
                        <td>${apt.specialization||''}</td>
                        <td>${apt.reason_for_visit||''}</td>
                        <td><span class="status-badge">${apt.status||''}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading appointments:', error);
                showToast('Error loading appointments');
            }
        }

        async function loadTreatments() {
            try {
                const response = await fetch(`${API_URL}/patient/treatments`, { headers });
                const data = await response.json();
                const tbody = document.querySelector('#treatmentsTable tbody');
                tbody.innerHTML = (data || []).map(t => `
                    <tr>
                        <td>${t.treatment_id||''}</td>
                        <td>${t.treatment_date||''}</td>
                        <td>${t.treatment_type||''}</td>
                        <td>${t.description||''}</td>
                        <td>${t.reason_for_visit||''}</td>
                        <td>‚Çπ${(t.cost||0).toFixed(2)}</td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading treatments:', error);
                showToast('Error loading treatments');
            }
        }

        async function loadBillings() {
            try {
                const response = await fetch(`${API_URL}/patient/billings`, { headers });
                const data = await response.json();
                const tbody = document.querySelector('#billingsTable tbody');
                tbody.innerHTML = (data || []).map(b => `
                    <tr>
                        <td>${b.bill_id||''}</td>
                        <td>${b.bill_date||''}</td>
                        <td>${b.treatment_type||''}</td>
                        <td>‚Çπ${(b.amount||0).toFixed(2)}</td>
                        <td>${b.payment_method||''}</td>
                        <td><span class="status-badge">${b.payment_status||''}</span></td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading billings:', error);
                showToast('Error loading billings');
            }
        }

        // Load doctors (available list)
        async function loadDoctors() {
            try {
                const response = await fetch(`${API_URL}/doctors/available`, { headers });
                const data = await response.json();
                const select = document.getElementById('doctorSelect');
                select.innerHTML = '<option value="">Choose a doctor...</option>';
                (data || []).forEach(doctor => {
                    const option = document.createElement('option');
                    option.value = doctor.doctor_id;
                    option.textContent = `Dr. ${doctor.first_name || ''} ${doctor.last_name || ''} - ${doctor.specialization || ''} (${doctor.hospital_branch || ''})`;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading doctors:', error);
                showToast('Error loading doctors');
            }
        }

        // Booking function with conflict & DB error handling
        
document.getElementById('reason').addEventListener('change', function() {
  const otherInput = document.getElementById('otherReason');
  if (this.value === 'Other') {
    otherInput.style.display = 'block';
    otherInput.required = true;
    otherInput.focus();
  } else {
    otherInput.style.display = 'none';
    otherInput.required = false;
    otherInput.value = '';
  }
});

document.getElementById('bookingForm').addEventListener('submit', async (e) => {
  e.preventDefault();

  const reasonVal = document.getElementById('reason').value;
  const otherVal = (document.getElementById('otherReason').value || '').trim();

  // decide final reason: if user selected Other and provided text, use that; otherwise use selection
  const finalReason = (reasonVal === 'Other' && otherVal) ? otherVal : reasonVal;

  const bookingData = {
    doctor_id: document.getElementById('doctorSelect').value,
    date: document.getElementById('appointmentDate').value,
    time: document.getElementById('appointmentTime').value,
    reason: finalReason,
    // send both fields (backend will use `reason` primarily)
    other_reason: otherVal
  };

  // validation: allow finalReason to be custom text if Other chosen
  if (!bookingData.doctor_id || !bookingData.date || !bookingData.time || !finalReason) {
    showToast('Please fill all fields (and provide reason if you selected Other).');
    return;
  }

  try {
    const res = await fetch(`${API_URL}/patient/book-appointment`, {
      method: 'POST',
      headers,
      body: JSON.stringify(bookingData)
    });

    if (res.ok) {
      const data = await res.json();
      showToast(data.message || 'Appointment booked successfully!');
      // reset form
      document.getElementById('bookingForm').reset();
      document.getElementById('otherReason').style.display = 'none';
      await loadAppointments();
    } else {
      let data = {};
      try { data = await res.json(); } catch(e){}
      const msg = data.message || 'Failed to book appointment';
      const details = data.error ? `\nDetails: ${data.error}` : '';
      alert(msg + details);
    }
  } catch (err) {
    alert('Network error: ' + err.message);
  }
});

        // Set minimum date to today
        document.getElementById('appointmentDate').min = new Date().toISOString().split('T')[0];

        // Load initial data
        loadProfile();
        loadAppointments();
        loadTreatments();
        loadBillings();
        loadDoctors();
    </script>
</body>
</html>
